{% extends 'base.html.twig' %}

{% block title %}{{ property.name }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/details.css') }}">
{% endblock %}

{% block body %}
    <div class="slideshow-container"
         style="max-width: 1000px; height: 500px; overflow: hidden; position: relative; margin: auto;">
        {% if property.propertyImages|length > 0 %}
            {% for image in property.propertyImages %}
                <div class="mySlides fade"
                     style="width: 100%; height: 100%; {% if loop.first %} display: block; {% else %} display: none; {% endif %}">
                    <div class="numbertext">{{ loop.index }} / {{ property.propertyImages|length }}</div>
                    <img src="{{ asset(image.imagePath) }}"
                         alt="Property Image {{ loop.index }}"
                         style="width: 100%; height: 100%; object-fit: cover;">
                </div>
            {% endfor %}
        {% else %}
            <div class="mySlides fade" style="width: 100%; height: 100%; display: block;">
                <img src="https://via.placeholder.com/1000x500" alt="No Image Available"
                     style="width: 100%; height: 100%; object-fit: cover;">
            </div>
        {% endif %}

        <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
        <a class="next" onclick="plusSlides(1)">&#10095;</a>
    </div>

    {% if property.propertyImages|length > 0 %}
        <div style="text-align:center">
            {% for image in property.propertyImages %}
                <span class="dot {% if loop.first %}active{% endif %}" onclick="currentSlide({{ loop.index }})"></span>
            {% endfor %}
        </div>
    {% endif %}

    <div class="real-estate-content-container">
        <div class="real-estate-detail">
            <div class="real-estate-detail-content">
                <div class="title-row">
                    <h1>{{ property.name }}</h1>
                    <div class="action-buttons">
                        {% if app.user %}
                            <div id="favorite-container">
                                <button type="button" id="favorite-toggle" class="favorite-button {% if isFavorite %}active{% endif %}" 
                                        data-property-slug="{{ property.slug }}" 
                                        data-is-favorite="{{ isFavorite ? 'true' : 'false' }}">
                                    <i class="fa {% if isFavorite %}fa-heart{% else %}fa-heart-o{% endif %}"></i>
                                    <span id="favorite-text">
                                        {% if isFavorite %}
                                            Remove from Favorites
                                        {% else %}
                                            Add to Favorites
                                        {% endif %}
                                    </span>
                                </button>
                            </div>
                        {% endif %}
                        <p class="upload-time">Date uploaded: {{ property.createdAt|date('d.m.Y H:i:s') }}</p>
                    </div>
                </div>
                <h2>{{ property.cityId.name }}, {{ property.regionId.name }}, {{ property.address }}</h2>

                <p class="price">â‚¬{{ property.price|number_format(0, ',', '.') }} ({{ (property.price / property.area)|round(2) }} EUR/m&sup2;)</p>

                <hr style="border: 0; border-top: 1px solid #ccc; margin: 15px 0;">

                <div class="details">
                    <span>Area: {{ property.area }} m&sup2;</span>
                    <span class="separator"> | </span>
                    <span>Type: {{ property.listingType.value }}</span>
                    <span class="separator"> | </span>
                    <span>Views: {{ property.views }}</span>
                </div>

                <div class="features">
                    <p>Features:</p>
                    {% if features|length > 0 %}
                        <ul class="features-list">
                            {% for feature in features %}
                                <li>
                                    <span class="material-symbols-outlined">{{ feature.icon }}</span>
                                    {{ feature.name }}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No features listed for this property.</p>
                    {% endif %}
                </div>

                <hr style="border: 0; border-top: 1px solid #ccc; margin: 15px 0;">
                <div class="details">
                    <p>Description: <br><br> {{ property.description }}</p>
                </div>

                {% if property.user %}
                    <hr style="border: 0; border-top: 1px solid #ccc; margin: 15px 0;">
                    <div class="contact-info">
                        <h3>Contact Information</h3>
                        <div class="contact-details">
                            <div class="user-info">
                                <div class="user-name">{{ property.user.firstName }} {{ property.user.lastName }}</div>
                                <div class="user-email">{{ property.user.email }}</div>
                                {% if property.user.phoneNumber %}
                                    <div class="user-phone">{{ property.user.phoneNumber }}</div>
                                {% endif %}
                            </div>
                            
                            {% if property.user.agencyId %}
                                <div class="agency-info">
                                    <h4>Agency Information</h4>
                                    <div class="agency-details">
                                        <div class="agency-name">{{ property.user.agencyId.name }}</div>
                                        <div class="agency-address">{{ property.user.agencyId.address }}</div>
                                        {% if property.user.agencyId.website %}
                                            <div class="agency-website">
                                                <a href="{{ property.user.agencyId.website }}" target="_blank" rel="noopener noreferrer">
                                                    Visit Website
                                                </a>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        let slideIndex = 1;

        document.addEventListener("DOMContentLoaded", () => {
            showSlides(slideIndex);
            
            // Initialize favorite button functionality
            const favoriteToggle = document.getElementById('favorite-toggle');
            if (favoriteToggle) {
                favoriteToggle.addEventListener('click', toggleFavorite);
            }
        });
        
        function toggleFavorite(event) {
            event.preventDefault();
            
            const button = document.getElementById('favorite-toggle');
            const slug = button.dataset.propertySlug;
            
            fetch(`{{ path('app_toggle_favorite', {'slug': 'PLACEHOLDER'}) }}`.replace('PLACEHOLDER', slug), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update button state
                    if (data.isFavorite) {
                        button.classList.add('active');
                        button.querySelector('i').classList.remove('fa-heart-o');
                        button.querySelector('i').classList.add('fa-heart');
                        document.getElementById('favorite-text').textContent = 'Remove from Favorites';
                    } else {
                        button.classList.remove('active');
                        button.querySelector('i').classList.remove('fa-heart');
                        button.querySelector('i').classList.add('fa-heart-o');
                        document.getElementById('favorite-text').textContent = 'Add to Favorites';
                    }
                    
                    // Show a temporary message
                    const container = document.getElementById('favorite-container');
                    const message = document.createElement('div');
                    message.textContent = data.message;
                    message.style.color = data.isFavorite ? '#10b981' : '#6b7280';
                    message.style.fontSize = '0.8rem';
                    message.style.marginTop = '5px';
                    container.appendChild(message);
                    
                    setTimeout(() => {
                        container.removeChild(message);
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function plusSlides(n) {
            showSlides(slideIndex += n);
        }

        function currentSlide(n) {
            showSlides(slideIndex = n);
        }

        function showSlides(n) {
            let i;
            let slides = document.getElementsByClassName("mySlides");
            let dots = document.getElementsByClassName("dot");

            if (n > slides.length) {
                slideIndex = 1;
            }
            if (n < 1) {
                slideIndex = slides.length;
            }

            for (i = 0; i < slides.length; i++) {
                slides[i].style.display = "none";
            }

            for (i = 0; i < dots.length; i++) {
                dots[i].className = dots[i].className.replace(" active", "");
            }

            slides[slideIndex - 1].style.display = "block";
            if (dots.length > 0) {
                dots[slideIndex - 1].className += " active";
            }
        }
    </script>
{% endblock %} 